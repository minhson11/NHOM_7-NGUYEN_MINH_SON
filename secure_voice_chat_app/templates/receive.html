<!-- receive.html - Giao di·ªán nh·∫≠n v√† x√°c minh tin nh·∫Øn. -->

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Secure Voice Chat - Nh·∫≠n tin</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f1f5f9;
      padding: 30px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 0 10px #ccc;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    h2 {
      color: #2d3748;
    }
    pre {
      background: #edf2f7;
      padding: 10px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }
    button {
      padding: 10px 20px;
      background: #3182ce;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background: #2b6cb0;
    }
    .hidden {
      display: none;
    }
    .result {
      margin-top: 15px;
      font-weight: bold;
    }
    .progress-container {
      margin-top: 20px;
      background-color: #e2e8f0;
      border-radius: 12px;
      overflow: hidden;
      height: 16px;
      width: 100%;
    }
    .progress-bar {
      height: 100%;
      width: 0%;
      background-color: #38a169;
      transition: width 2.5s ease;
    }
  </style>
</head>
<body>

<div class="card">
  <h2>üì• Nh·∫≠n g√≥i tin m√£ h√≥a</h2>

  <p><strong>Chi ti·∫øt g√≥i tin:</strong></p>
  <pre id="packet-display"></pre>

  <button onclick="verifyPacket()">üõ°Ô∏è X√°c minh v√† gi·∫£i m√£</button>

  <div class="progress-container hidden" id="progress-box">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <div class="result" id="result-message"></div>

  <audio id="audio-player" controls class="hidden" style="margin-top:15px;">
    <source src="{{ url_for('static', filename='decrypted.wav') }}" type="audio/wav">
    Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.
  </audio>
</div>

<!-- G√≥i tin truy·ªÅn t·ª´ server -->
<div id="packet-data" data-packet='{{ packet | tojson | safe }}' class="hidden"></div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const packetStr = document.getElementById('packet-data').dataset.packet;
    const packet = JSON.parse(packetStr);

    // Hi·ªÉn th·ªã chi ti·∫øt g√≥i tin
    const display = `
üîê AES Key (encrypted):\n${packet.encrypted_aes_key.slice(0, 60)}...
üßä IV: ${packet.iv}
üîí Ciphertext: ${packet.cipher.slice(0, 60)}...
#Ô∏è‚É£ Hash: ${packet.hash}
üñäÔ∏è Ch·ªØ k√Ω: ${packet.sig.slice(0, 60)}...
    `;
    document.getElementById("packet-display").textContent = display;

    window.verifyPacket = async function () {
      const progressBox = document.getElementById('progress-box');
      const progressBar = document.getElementById('progress-bar');
      const msgBox = document.getElementById('result-message');
      const audioPlayer = document.getElementById('audio-player');
      const audioSource = audioPlayer.querySelector("source");

      // Reset tr·∫°ng th√°i
      msgBox.textContent = '';
      audioPlayer.classList.add('hidden');

      // Hi·ªán progress bar
      progressBox.classList.remove('hidden');
      progressBar.style.width = '100%';

      // Gi·∫£ l·∫≠p loading
      await new Promise(r => setTimeout(r, 2500));

      // G·ª≠i y√™u c·∫ßu x√°c minh t·ªõi server
      const response = await fetch('/verify', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(packet)
      });

      const result = await response.json();

      progressBox.classList.add('hidden');

      if (result.status === "ACK") {
        msgBox.textContent = "‚úÖ X√°c minh th√†nh c√¥ng: D·ªØ li·ªáu h·ª£p l·ªá v√† ƒë√£ ƒë∆∞·ª£c gi·∫£i m√£!";
        msgBox.style.color = "green";

        // X·ª≠ l√Ω theo lo·∫°i file
        if (packet.file_type === "audio") {
            // √âp reload file √¢m thanh v√† tr√°nh cache
            const timestamp = new Date().getTime();
            audioSource.src = `/static/decrypted.wav?t=${timestamp}`;
            audioPlayer.load();
            audioPlayer.classList.remove('hidden');
            audioPlayer.play().catch(err => {
                console.warn("‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng t·ª± ƒë·ªông ph√°t:", err);
            });
        } else if (packet.file_type === "text") {
            // Hi·ªÉn th·ªã n·ªôi dung text
            fetch('/static/decrypted.txt')
                .then(res => res.text())
                .then(text => {
                    const pre = document.createElement("pre");
                    pre.textContent = text;
                    document.querySelector(".card").appendChild(pre);
                });
        }
        } else {
            msgBox.textContent = "‚ùå X√°c minh th·∫•t b·∫°i: " + result.reason;
            msgBox.style.color = "red";
          }

          setTimeout(() => {
            progressBar.style.width = '0%';
          }, 500);
        };
      });
</script>

</body>
</html>
